###### Frequency of rectangles by size #########
# This is a mess

rm(list = ls())
# setup F
library(here)
source(here("getLearnerHypDistributions.R"))
source(here("calculatingFunctions.R"))
source(here("plottingFunctions.R"))

# load generic data
load(here("experiment-2/data/derived/all_conditions.Rdata"))
source(here("getLearnerHypDistributions.R"))
load(here("experiment-scenarios/target-blocks/data/target-block-8-Cartesian.Rdata"))
observations = targetBlock$observations

# load participant data
load(here("experiment-2/data/derived/data_cartesian.Rdata"))

# Model predictions -------------------------------------------------------

alphas <- c(-2,0,2)
clues <- c(4)
# Predicted distributions for each alpha 
all_dists = NULL
for (i in 1:length(alphas)){
  dist <- getLearnerHypDistribution(observations, alpha = alphas[i], prior = "flat")
  # convert to df (probably a better way than this)
  distDf <- NULL 
  for (j in clues){
    distBlock <- dist[[clues]]
    distDf <- rbind(distDf, distBlock)
  }
  all_dists <- rbind(all_dists,distDf)
}

# get probability distributions
all_dists <- all_dists %>%
  mutate(Alpha = as.factor(alpha)) %>%
  mutate(clue_name = case_when(
    clue == 1 ~ "1st Clue",
    clue == 4 ~ "4th Clue"
  ))



# Participant responses ---------------------------------------------------

sizeHist = function(data, condition, plotAlpha){
  data %>%
    filter(cond == condition & alpha == plotAlpha) %>%
    ggplot(aes(x = factor(size))) +
    geom_col(aes(y = count, fill = cond)) + 
    geom_line(aes(y = prob*250, colour = factor(alpha), group = factor(alpha)), linewidth = 0.8)+ # get on same scale
    scale_fill_manual(values = c("HS" = "darkgreen", "HN" = "darkgreen", "RS" = "lightblue", "RN" = "lightblue", "MS" = "darkred", "MN" = "darkred", "UN" = "orange", "US" = "orange"))+
    #geom_line(data = all_dists, aes(x = size, y = posterior, colour = Alpha))+
    scale_colour_manual(values = c("2" = "darkseagreen", "0" = "blue", "-2" = "red3"))+
    labs(y = "Count")+
    #scale_y_continuous(sec.axis = sec_axis(~.*0.0005, name="Posterior")) +
    theme_classic()+
    ylim(c(0,82))+
    theme(axis.text.x=element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x=element_blank(),
          #axis.text.y=element_blank(),
          #axis.ticks.y=element_blank(),
          text = element_text(size = 12),
          #strip.background = element_blank(),
          #plot.margin = margin(-1, 0, -1, 0, "cm"),
          strip.text = element_text(margin = margin(0,0,0,0, "cm"), size = 5),
          legend.position = "none")
  #facet_wrap(~cond+Experiment, ncol = 2)
}

# Need to make a single data frame with participant response, size, and probability. 

# get probability of a certain sized rectangleunder a certain alpha 

d_sizes <- all_dists %>%
  group_by(alpha, size) %>%
  summarise(prob = median(posterior))
d_sizes$count = 0


# function to help match the frequency of rectangles generated by a participant with that rectangles probabiltiy
replace_count <- function(d_size, d_cond) {
  for (i in 1:nrow(d_size)) {
    size_match <- d_cond$size_resp == d_size$size[i]
    if (any(size_match)) {
      d_size$count[i] <- d_cond$count[which(size_match)]
    }
  }
  return(d_size)
}

d_all_sizes <- NULL


# We're only interested in the 8th block and 4th clue
all_conditions_4_8 <- all_conditions %>%
  filter(clues == 4 & targetBlocks == 8)
nConds <- length(all_conditions_4_8[,1])
b <- 8
c <- 4


# Populate the "count" column in d_sizes for each condition, then make a single
# large data frame with sizes, probability, alpha, and frequency for each  condition
for (i in 1:nConds ){
  condition <- all_conditions_4_8[i,"conditions"]
  
  d_cond <- d_cartesian %>% 
    filter(block == b & clue == c & cond == condition) %>%
    group_by(size_resp) %>%
    summarise(count = n())
  
  d_cond_sizes <- replace_count(d_sizes, d_cond)
  d_cond_sizes$cond <- condition
  d_all_sizes <- rbind(d_all_sizes, d_cond_sizes)
}

all_conditions_4_8 <- all_conditions_4_8 %>% 
  mutate(plotAlpha = case_when(
    conditions == "HS" | conditions == "HN" ~ 2,
    conditions == "MS" | conditions == "MN" | conditions == "UN" | conditions == "US" ~ -2,
    conditions == "RS" | conditions == "RN" ~ 0
  ))

# Plot

# loop through all conditions and make a plot for each

for (i in 1:length(all_conditions_4_8[,1])){
  condition <- all_conditions_4_8[i,"conditions"]
  plotAlpha <- all_conditions_4_8[i,"plotAlpha"]
  sizeHist(d_all_sizes, condition, plotAlpha)
  ggsave(filename = here(paste0("experiment-2/modelling/05_plots/size_hist_b8_c4_",condition,".png")), width = 7, height = 2.3)
}


