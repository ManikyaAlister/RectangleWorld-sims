---
title: "experimentSim"
author: "Manikya Alister"
date: "25/11/2022"
output: 
  html_document:
    theme: simplex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
source("functions/optimiseAlpha.R")
```

```{r}
# Set up rectangle space
borders = makeBorders(0:10)
nTriangles = 3
nPos = c(1,2,3)
nNeg = c(1,2,3)

```

# Simulate Experiment

1. Generate a whole bunch of trial scenarios 

a. Generate a different "true" rectangle for each trial. 

```{r}
# Generate true rectangles 
trueRects = as.data.frame(rbind(c(2,2,4,4), c(2,2,5,5), c(2,2,9,9)))

```

```{r}
# plot
rectScenarios = cbind(trueRects, 1:length(trueRects[,1]) )
colnames(rectScenarios) = c("x1", "y1", "x2", "y2", "Unique Rectangle")

ggplot(data = rectScenarios) +
  geom_rect(aes(xmin = x1, xmax = x2, ymin = y1, ymax = y2), colour = "black", alpha = 0)+
  labs(title = "Rectangle Configurations")+
  scale_x_discrete(limits = factor(0:10)) +
  scale_y_discrete(limits = factor(0:10)) +
  theme_bw()+
  theme(axis.text = element_blank(), panel.grid = element_line(colour = "grey", linetype = 1))+
  facet_wrap(~`Unique Rectangle`)

```

b. Generate observations for each trial rectangle and observation condition.

```{r}
# Number of Data Points Levels: 2,4,6 (1 pos 1 neg in each)
allObs = generateObs(nPos,nNeg,rectScenarios)
```


```{r fig.height= 10, fig.width=10}
# plot 
plotData1 = allObs[allObs[,"nObsCond"]==1,]
plotData1$obsCond = 1

plotData2 = allObs[allObs[,"nObsCond"]<=2,]
plotData2$obsCond = 2

plotData3 = allObs[allObs[,"nObsCond"]<=3,]
plotData3$obsCond = 3

plotData = rbind(plotData1, plotData2, plotData3)

ggplot(data = plotData) +
  geom_rect(aes(xmin = x1, xmax = x2, ymin = y1, ymax = y2), colour = "black", alpha = 0)+
  geom_point(aes(x = x, y = y, colour = category))+
  labs(title = "Trial Configurations")+
  theme_bw()+
  theme(axis.text = element_blank(), panel.grid = element_line(colour = "grey", linetype = 1))+
  scale_x_discrete(limits = factor(0:10)) +
  scale_y_discrete(limits = factor(0:10)) +
  facet_wrap(~`Unique Rectangle`+obsCond)
```

2. Generate participant responses to those trials (with varied alphas)

```{r}
p1 = simulatePar(observations = allObs,borders = borders)
allP = NULL
for (j in 1: nTriangles) {
  for ( i in 1:length(nPos)){
    observations = allObs[allObs[,"nObsCond"] == i & allObs[,"Unique Rectangle"] == j, ]
    trial = c(j,i)
    p = cbind(simulatePar(observations = observations,borders = borders), trial)
    allP =  rbind(allP, p)
  }
}


```

3. Estimate alpha that best describes each participant. 

```{r}
gridSearch = alphaGridSearch(borders, allObs[1:2,])
```


4. Visualize 

e.g., Heat map, probability distribution as a function of size, generating v estimating parameter (recovery).

```{r}

```


<!-- One trial:  -->

<!-- ```{r} -->
<!-- nTrials = 1 -->
<!-- nPos = 1 -->
<!-- nNeg = 1 -->
<!-- nRectangles = 1 -->
<!-- trueRects = genTrueRects(1, borders) -->

<!-- obs1 = generateObs(nPos, nNeg, 1, trueRects) -->
<!-- alphas1 = alphaGridSearch(borders, obs1[,1:3]) -->

<!-- p1a0 = simulatePar(obs1, borders, alpha = 0) -->
<!-- p1a1 = simulatePar(obs1, borders, alpha = 1) -->
<!-- p1aNeg1 = simulatePar(obs1, borders, alpha = -1) -->

<!-- test1a0 = fitAlpha(p1a0, alphas1) -->
<!-- test1a1 = fitAlpha(p1a1, alphas1) -->
<!-- test1aNeg1 = fitAlpha(p1aNeg1, alphas1) -->

<!-- ### Turn into function  -->

<!-- overlap = NULL -->
<!-- for (i in 1:length(alphas1[,1])) { -->
<!--   overlap[i] = rectOverlap(alphas1[i,1:4], p1) -->
<!-- } -->

<!-- alphas1[overlap == 1, ] -->

<!-- ##################### -->

<!-- class(p1) -->

<!-- alphas1[alphas1[,"alpha"] == 0,] -->
<!-- pedLearner(borders, obs1, prior, alpha = alphaRange[i]) -->
<!-- # every single rectangle is eligible in alpha = 0, so I need something that says which are more likely, e.g., relitive probability of 1 rectangle (n best rectangles/how many rectangles are eligible for each one) -->


<!-- tmp = as.numeric(alphas1[1,1:4]) -->
<!-- class(tmp[1]) -->
<!-- tmp[3] -->

<!-- max(c(alphas1[1,1:4], alphas1[1,1:4][3])) -->

<!-- debugonce(rectOverlap) -->

<!-- # looks like it can distinguish between alpha < 0, 0, >0 but not individual alphas.  -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # simulate some observations -->
<!-- nTrials = 3 -->
<!-- nPos = c(1, 2, 3) -->
<!-- nNeg = c(1, 2, 3) -->
<!-- nRectangles = 5 # number of unique rectangles (2, 4, and 6 points for each unique rectangle) -->
<!-- trueRects = genTrueRects(nRectangles, borders) -->

<!-- simObs = generateObs(nPos, nNeg, nTrials, trueRects) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # small rectangle -->
<!-- smallRect = c(6,6,8,8) -->
<!-- allObservations = weakSampler(30, smallRect) -->
<!-- obsPos = allObservations[allObservations[,"category"] == "positive",] -->
<!-- obsNeg = allObservations[allObservations[,"category"] == "negative",] -->

<!-- # Large rectangle  -->

<!-- largeRect = c(2,2,8,8) -->

<!-- obs = samplePosNeg(4,2,largeRect) -->
<!-- test1 = alphaGridSearch(borders = borders, observations = obs) -->
<!-- plotAlphaPredictions(rects = test1, obs = obs, largeRect) -->

<!-- obs2 = samplePosNeg(1,1,largeRect)  -->
<!-- test1 = alphaGridSearch(borders = borders, observations = obs2) -->
<!-- plotAlphaPredictions(rects = test1, obs = obs2, largeRect) -->


<!-- ``` -->

